---
site: distill::distill_website
params:
  gdl_id: "CB594"
---
---
title: `r params$gdl_id`
description: | 
  Technical details
---


```{r setup, message=F}
library(GeoPressureR)
library(leaflet)
library(leaflet.extras)
library(raster)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(plotly)
library(GeoLocTools)
setupGeolocation()
knitr::opts_chunk$set(echo = FALSE)
load(paste0("../data/1_pressure/", params$gdl_id, "_pressure_prob.Rdata"))
# load(paste0("../data/2_light/", params$gdl_id, "_light_prob.Rdata"))
load(paste0("../data/3_static/", params$gdl_id, "_static_prob.Rdata"))
load(paste0("../data/4_basic_graph/", params$gdl_id, "_basic_graph.Rdata"))
col <- rep(RColorBrewer::brewer.pal(8, "Dark2"), times = ceiling(max(pam$sta$sta_id) / 8))
```

## Settings used

All the results produced here are generated with (1) the raw geolocator data, (2) the labeled files of pressure and light and (3) the parameters listed below.

```{r layout="l-page"}
kable(gpr) %>% scroll_box(width = "100%")
```

## Pressure timeserie

The labeling of pressure data is illustrated with this figure. The black dots indicates the pressure datapoint not considered in the matching. Each stationary period is illustrated by a different colored line.

```{r, layout="l-page"}
pressure_na <- pam$pressure %>%
  mutate(obs = ifelse(isoutliar | sta_id == 0, NA, obs))
p <- ggplot() +
  geom_line(data = pam$pressure, aes(x = date, y = obs), colour = "grey") +
  geom_point(data = subset(pam$pressure, isoutliar), aes(x = date, y = obs), colour = "black") +
  # geom_line(data = pressure_na, aes(x = date, y = obs, color = factor(sta_id)), size = 0.5) +
  geom_line(data = do.call("rbind", shortest_path_timeserie) %>% filter(sta_id > 0), aes(x = date, y = pressure0, col = factor(sta_id))) +
  theme_bw() +
  scale_colour_manual(values = col) +
  scale_y_continuous(name = "Pressure(hPa)")

ggplotly(p, dynamicTicks = T) %>% layout(showlegend = F)
```

## Pressure calibration

```{r, layout="l-page"}
sp_pressure <- do.call("rbind", shortest_path_timeserie) %>% filter(sta_id > 0)

sta_plot <- which(difftime(pam$sta$end, pam$sta$start, unit = "days") > 3)

par(mfrow = c(2, 3))
for (i in seq_len(length(sta_plot))) {
  i_s <- sta_plot[i]
  pressure_s <- pam$pressure %>%
    filter(sta_id == i_s & !isoutliar)

  err <- pressure_s %>%
    left_join(sp_pressure, by = c("date","obs")) %>%
    mutate(
      err = obs - pressure - mean(obs - pressure, na.rm=T)
    ) %>%
    .$err

  hist(err, freq = F, main = paste0("sta_id=", i_s, " | ", nrow(pressure_s), " dtpts | std=", round(sd(err, na.rm=T), 2)))
  xfit <- seq(min(err, na.rm=T), max(err, na.rm=T), length = 40)
  yfit <- dnorm(xfit, mean = mean(err, na.rm=T), sd = sd(err, na.rm=T))
  lines(xfit, yfit, col = "red")
}
```


## Stationay period information

```{r}
pam$sta %>% kable()
```
